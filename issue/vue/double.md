[自定义模拟 Vue 的双向绑定](https://www.cnblogs.com/chenhuichao/p/10818396.html)

# **Vue 的底层原理：双向数据绑定**

1. 简单说明：双向数据绑定是通过数据劫持和发布者-订阅者模式结合实现的。

2. 具体说明：

   核心函数就是 **Object.defineProperty()** 循环遍历 Vue 实例里的 data 对象并且绑定上 setter（数据发生变动则会触发）和 getter（获取数据时则会触发），当数据发生变动时，则会触发相应的 setter 函数并且被监听器监听到然后发送到订阅器 Dep 中，然后所有订阅者就会触发相应的函数，从而更新视图。

   ![](../../img/double.png)

3.主要分为三大步骤：

- 实现一个监听器 Observer，用来劫持并监听所有属性，如果有变动的，就通知订阅者。
- 实现一个订阅者 Watcher，可以收到属性的变化通知并执行相应的函数，从而更新视图。
- 实现一个解析器 Compile，可以扫描和解析每个节点的相关指令，并根据初始化模板数据以及初始化相应的订阅者。

  4.实现一个 Observer

- Observer 是一个数据监听器，其实现核心方法就是前文所说的 Object.defineProperty( )。如果要对所有属性都进行监听的话，那么可以通过递归方法遍历所有属性值，并对其进行 Object.defineProperty( )处理。
- 思路分析中，需要创建一个可以容纳订阅者的消息订阅器 Dep，订阅器 Dep 主要负责收集订阅者，然后再属性变化的时候执行对应订阅者的更新函数。所以显然订阅器需要有一个容器，这个容器就是 list，将上面的 Observer 稍微改造下，植入消息订阅器：
- 我们将订阅器 Dep 添加一个订阅者设计在 getter 里面，这是为了让 Watcher 初始化进行触发，因此需要判断是否要添加订阅者，至于具体设计方案，下文会详细说明的。在 setter 函数里面，如果数据变化，就会去通知所有订阅者，订阅者们就会去执行对应的更新的函数。

  5.实现 Watcher

- 订阅者 Watcher 在初始化的时候需要将自己添加进订阅器 Dep 中，那该如何添加呢？我们已经知道监听器 Observer 是在 get 函数执行了添加订阅者 Wather 的操作的，所以我们只要在订阅者 Watcher 初始化的时候出发对应的 get 函数去执行添加订阅者操作即可，那要如何触发 get 的函数，再简单不过了，只要获取对应的属性值就可以触发了，核心原因就是因为我们使用了 Object.defineProperty( )进行数据监听。这里还有一个细节点需要处理，我们只要在订阅者 Watcher 初始化的时候才需要添加订阅者，所以需要做一个判断操作，因此可以在订阅器上做一下手脚：在 Dep.target 上缓存下订阅者，添加成功后再将其去掉就可以了。

- 需要在 new SelfVue 的时候做一个代理处理，让访问 selfVue 的属性代理为访问 selfVue.data 的属性，实现原理还是使用 Object.defineProperty( )对属性值再包一层

  6.实现 Compile

- 解析模板指令，并替换模板数据，初始化视图
- 将模板指令对应的节点绑定对应的更新函数，初始化相应的订阅器
- 为了解析模板，首先需要获取到 dom 元素，然后对含有 dom 元素上含有指令的节点进行处理，因此这个环节需要对 dom 操作比较频繁，所有可以先建一个 fragment 片段，将需要解析的 dom 节点存入 fragment 片段里再进行处理
